import re
import json
from typing import List, Dict, Tuple
import random

class ChatbotAI:
    def __init__(self):
        self.faq_data = []
        self.conversation_history = []
        
        # ุงูฺฏููุง ูพุงุณุฎ ููุดููุฏ
        self.response_patterns = {
            'greeting': [
                "ุณูุงู! ๐ ุฎูุด ุขูุฏุฏ. ูู ุฑุจุงุช ููุดููุฏ APM Show ูุณุชู. ฺุทูุฑ ูโุชููู ฺฉูฺฉุชูู ฺฉููุ",
                "ุฏุฑูุฏ! ุจู ูพุดุชุจุงู ุขููุงู APM Show ุฎูุด ุขูุฏุฏ. ฺู ุณูุงู ุฏุงุฑุฏุ",
                "ุณูุงู ุนุฒุฒ! ๐ ุฎูุดุญุงูู ฺฉู ุงูุฌุงุฏ. ฺฺฏููู ูโุชูุงูู ุดูุง ุฑุง ุฑุงูููุง ฺฉููุ"
            ],
            
            'size_help': [
                "ุจุฑุง ุงูุชุฎุงุจ ุณุงุฒ ููุงุณุจุ ูพุดููุงุฏ ูโฺฉูู:\n\n1๏ธโฃ ุงุฒ ุฌุฏูู ุณุงุฒ ุฏุฑ ุตูุญู ูุญุตูู ุงุณุชูุงุฏู ฺฉูุฏ\n2๏ธโฃ ุงฺฏุฑ ุจู ุฏู ุณุงุฒ ูุฑุฏุฏ ูุณุชุฏุ ูุฏ ู ูุฒู ุฎูุฏ ุฑุง ุจูุฑุณุชุฏ\n3๏ธโฃ ูุนูููุงู ุงฺฏุฑ ูุฑู ุจุฏู ุงุณุชุงูุฏุงุฑุฏ ุฏุงุฑุฏุ ุณุงุฒ ูุนููู ููุงุณุจ ุดูุงุณุช\n4๏ธโฃ ุจุฑุง ูุจุงุณโูุง ูุชุ ฺฉ ุณุงุฒ ุจุฒุฑฺฏุชุฑ ุงูุชุฎุงุจ ฺฉูุฏ\n\nุณุงุฒ ุฏูู ูุฑ ูุญุตูู ุฏุฑ ุชูุถุญุงุช ุฏุฑุฌ ุดุฏู ุงุณุช.",
                "ุงูุชุฎุงุจ ุณุงุฒ ุฏุฑุณุช ุฎู ูููู! ๐ค\n\nโข ูุจุงุณโูุง ุขุฒุงุฏ: ุณุงุฒ ูุนููู\nโข ูุจุงุณโูุง ูุช: ฺฉ ุณุงุฒ ุจุฒุฑฺฏุชุฑ\nโข ุงฺฏุฑ ุดฺฉ ุฏุงุฑุฏุ ุณุงุฒ ุจุฒุฑฺฏุชุฑ ุฑู ุงูุชุฎุงุจ ฺฉูุฏ\n\nูุฏ ู ูุฒู ุดูุง ฺูุฏูุ ูโุชููู ุจูุชุฑ ุฑุงูููุงุชูู ฺฉูู.",
                "ูููุชุฑู ูฺฉุชู ุฏุฑ ุงูุชุฎุงุจ ุณุงุฒุ ุชูุฌู ุจู ุฌุฏูู ุณุงุฒ ูุญุตููู. ูุฑ ูุญุตูู ุงูุฏุงุฒูโูุง ุฎุงุต ุฎูุฏุด ุฑู ุฏุงุฑู. ูุนูููุงู ูุดุชุฑโูุง ุจุง ูุฏ 170-180 ู ูุฒู 60-75 ฺฉููฺฏุฑูุ ุณุงุฒ M ุฑู ุงูุชุฎุงุจ ูโฺฉูู."
            ],
            
            'delivery_explain': [
                "โณ ุฏุฑุจุงุฑู ุฒูุงู ุงุฑุณุงู:\n\nุจู ุฏูู ุชููุฏ ุจูุฏู ูุฌููุนู ู ุชูุฌู ุจู ฺฉูุชุ ูุฑ ูุญุตูู ุจุง ุฏูุช ู ุญูุตูู ุชููุฏ ูโุดูุฏ. ูุนูููุงู ุฒูุงูโุจูุฏ ุจู ุงู ุตูุฑุชู:\n\nโข ุขูุงุฏูโุณุงุฒ: 1-2 ุฑูุฒ ฺฉุงุฑ\nโข ุชููุฏ: 2-3 ุฑูุฒ ฺฉุงุฑ\nโข ุงุฑุณุงู: 1-2 ุฑูุฒ ฺฉุงุฑ\n\nูุฌููุนุงู 2-5 ุฑูุฒ ฺฉุงุฑ ุทูู ูโฺฉุดู. ุงูุง ูุทูุฆู ุจุงุดุฏ ุงุฑุฒุด ููุชุธุฑ ูููุฏู ุฑู ุฏุงุฑู!",
                "ุฏุฑฺฉ ูโฺฉูู ฺฉู ููุชุธุฑ ูููุฏู ุณุฎุชโู. ุงูุง ุฏูู ุชุฃุฎุฑ ุงูู ฺฉู:\n\nโจ ูุฑ ูุญุตูู ุงุฎุชุตุงุต ุจุฑุง ุดูุง ุชููุฏ ูโุดู\nโจ ฺฉูุชุฑู ฺฉูุช ุดุฏุฏ ุฑู ููู ูุฑุงุญู ุฏุงุฑู\nโจ ุฏูุช ุฏุฑ ุฏูุฎุช ู ุฌูุณ ูพุงุฑฺู ุฒูุงูโุจุฑู\n\nูุฏู ูุง ุฑุถุงุช ุดูุงุณุชุ ูู ุณุฑุนุช ุจโฺฉูุช!",
                "ุชููุฏ ูุง ูุซู ูุณุช ูุดู ูุณุช ฺฉู ุงูุจุงุฑ ูพุฑ ุฏุงุดุชู ุจุงุดู. ูุฑ ุณูุงุฑุด ุฌุฏุงฺฏุงูู ุชููุฏ ูโุดู ุชุง ุจูุชุฑู ฺฉูุช ุฑู ุฏุฑุงูุช ฺฉูุฏ. ุงู ฺฉุงุฑ ุฒูุงู ูโุจุฑู ุงูุง ูุชุฌูโุงุด ูุญุตูู ุนุงูโุณุช ฺฉู ุณุงูโูุง ุงุฒุด ุงุณุชูุงุฏู ูโฺฉูุฏ."
            ],
            
            'quality_explain': [
                "๐ฅ ุฏุฑุจุงุฑู ฺฉูุช ูุญุตููุงุช:\n\nโข ูพุงุฑฺูโูุง: ุฏุฑุฌู ฺฉ ู ุถุฏ ุญุณุงุณุช\nโข ุฏูุฎุช: ุฏูู ู ุจุง ูุงุดูโุขูุงุช ูพุดุฑูุชู\nโข ฺุงูพ: ุซุงุจุช ู ุจุง ฺฉูุช ุจุงูุง\nโข ฺฉูุชุฑู ฺฉูุช: ูุฑ ูุญุตูู ูุจู ุงุฒ ุงุฑุณุงู ุจุฑุฑุณ ูโุดู\n\nูุง ุฑู ฺฉูุช ูุตุงูุญู ููโฺฉูู!",
                "ฺฉูุช ุจุฑุง ูุง ุงูููุชู! ๐\n\nุชูุงู ูุญุตููุงุช:\nโ ุชููุฏ ุฏุงุฎู\nโ ููุงุฏ ุงููู ูุฑุบูุจ\nโ ุฏูุฎุช ุฏูู\nโ ุจุฑุฑุณ ููุง\n\nุชุง ุญุงูุง ุจุด ุงุฒ 5000 ูุดุชุฑ ุฑุงุถ ุฏุงุดุชู ฺฉู ฺฏูุงู ฺฉูุช ฺฉุงุฑููู ูุณุช.",
                "ุชูุงูุช ูุญุตููุงุช ูุง ุฏุฑ ุชูุฌู ุจู ุฌุฒุฆุงุชโุณุช:\nโข ุฏุฑุฒูุง ูุฎู\nโข ุฒูพ ุจุง ุฏูุงู\nโข ฺุงูพ ุถุฏ ุขุจ\nโข ูพุงุฑฺู ูุฑู ู ูุทู\n\nูุฑ ูุญุตูู ุณุฑูุงูโฺฏุฐุงุฑ ุฑู ฺฉูุช ุฒูุฏฺฏ ุดูุงุณุช!"
            ],
            
            'tracking_help': [
                "ุจุฑุง ูพฺฏุฑ ุณูุงุฑุด:\n\n1๏ธโฃ ุดูุงุฑู ุณูุงุฑุด ุฎูุฏ ุฑุง ุจูุฑุณุชุฏ\n2๏ธโฃ ุง ุดูุงุฑู ููุจุงู ุซุจุชโุดุฏู ุฑุง ุงุนูุงู ฺฉูุฏ\n3๏ธโฃ ุง ููุชุธุฑ ูพุงูฺฉ ฺฉุฏ ุฑูฺฏุฑ ุจุงุดุฏ\n\nุงฺฏุฑ ฺฉุฏ ุฑูฺฏุฑ ูุฏุงุฑุฏุ ุนู ุณูุงุฑุด ุฏุฑ ุญุงู ุขูุงุฏูโุณุงุฒ ุงุณุช.",
                "๐ฆ ูุถุนุช ุณูุงุฑุดุงุช:\n\nโข ุซุจุชโุดุฏู: ุฏุฑ ุตู ุชููุฏ\nโข ุฏุฑ ุญุงู ุชููุฏ: ุฑู ุฏุณุช ุฏุงุฑู!\nโข ุขูุงุฏู: ุฏุฑ ุญุงู ุจุณุชูโุจูุฏ\nโข ุงุฑุณุงู ุดุฏู: ฺฉุฏ ุฑูฺฏุฑ ูุนุงู ุดุฏู\n\nุดูุงุฑู ุณูุงุฑุดุชูู ฺูุฏูุ ุจุฑุงุชูู ฺฺฉ ูโฺฉูู."
            ],
            
            'return_policy': [
                "๐ ุณุงุณุช ุจุงุฒฺฏุดุช:\n\nุจู ุฏูู ุชููุฏ ุงุฎุชุตุงุต ู ุจุฑูุงููโุฑุฒ ุฏููุ ุจุงุฒฺฏุดุช ูุฌู ูพุณ ุงุฒ ุดุฑูุน ุชููุฏ ุงูฺฉุงูโูพุฐุฑ ูุณุช. ุฏููุด ุงูู ฺฉู:\n\nโข ููุงุฏ ุงููู ุจุฑุง ุณูุงุฑุด ุดูุง ุชูู ุดุฏู\nโข ุฒูุงู ุชููุฏ ุงุฎุชุตุงุต ุฏุงุฏู ุดุฏู\nโข ูุฑู ฺฉุงุฑ ุจุฑูุงููโุฑุฒ ุดุฏู\n\nูุทูุงู ูุจู ุงุฒ ุฎุฑุฏุ ุณุงุฒ ู ูุดุฎุตุงุช ุฑุง ุฏูู ุจุฑุฑุณ ฺฉูุฏ.",
                "ุฏุฑฺฉ ูโฺฉูู ฺฉู ููฺฉูู ูุงุฒ ุจู ุจุงุฒฺฏุดุช ุฏุงุดุชู ุจุงุดุฏุ ุงูุง ุชููุฏ ูุง ุจุฑ ุงุณุงุณ ุณูุงุฑุดโุณุช. ููุช ุณูุงุฑุด ุซุจุช ูโุดูุ ฺุฑุฎู ุชููุฏ ุดุฑูุน ูโุดู ู ูุชููู ฺฉุฑุฏูุด ุจู ุถุฑุฑ ูููโุณุช.\n\nุฑุงูโุญู: ูุจู ุงุฒ ุฎุฑุฏ ุจุง ุฏูุช ุงูุชุฎุงุจ ฺฉูุฏ. ุงฺฏุฑ ุณุงุฒ ุงุดุชุจุงู ุจูุฏุ ุฏุฑ ุตูุฑุช ููุฌูุฏ ุจูุฏู ูโุชููู ุชุนูุถ ฺฉูู."
            ],
            
            'price_explain': [
                "๐ฐ ุฏุฑุจุงุฑู ููุชโูุง:\n\nููุช ุจุฑ ุงุณุงุณ:\nโข ฺฉูุช ููุงุฏ ุงููู\nโข ุฒูุงู ุชููุฏ\nโข ุฏูุช ุฏูุฎุช\nโข ุทุฑุงุญ ุงุฎุชุตุงุต\n\nุงุฑุฒุงู ุจูุฏู ูุฏู ูุง ูุณุชุ ฺฉูุช ุจุงูุงุณุช. ูุฑ ุฑุงูุด ุงุฑุฒุดุด ุฑู ุฏุงุฑู!",
                "ูุฑู ููุช ูุง ุจุง ุฏฺฏุฑุงู ุฏุฑ ฺฉูุชโุณุช! ูุญุตููุงุช ูุง:\nโ ุฏูุงู ุจุงูุง\nโ ุทุฑุงุญ ููุญุตุฑ ุจู ูุฑุฏ\nโ ูพุงุฑฺู ูุฑุบูุจ\nโ ุฏูุฎุช ุฏูู\n\nุงูโูุง ุงุฑุฒุด ูพููุชูู ุฑู ฺูุฏ ุจุฑุงุจุฑ ูโฺฉูู."
            ],
            
            'human_request': [
                "ุจุฑุง ุงุฑุชุจุงุท ุจุง ุงูพุฑุงุชูุฑ ุงูุณุงูุ ูุทูุงู ุจู ุขโุฏ ุงูุณุชุงฺฏุฑุงู ูุง ูพุงู ุฏูุฏ: @apmshow_\n\nุชู ูพุดุชุจุงู ุฏุฑ ุณุฑุนโุชุฑู ุฒูุงู ูพุงุณุฎฺฏูุณุช.",
                "ุงฺฏุฑ ูุงุฒ ุจู ุตุญุจุช ุจุง ุงูพุฑุงุชูุฑ ุฏุงุฑุฏุ ูพุงู ุฎูุฏ ุฑุง ุจู @apmshow_ ุฏุฑ ุงูุณุชุงฺฏุฑุงู ุงุฑุณุงู ฺฉูุฏ.\n\nุณุงุนุช ฺฉุงุฑ: 9 ุตุจุญ ุชุง 9 ุดุจ"
            ],
            
            'insult_response': [
                "ูุทูุงู ูุญุชุฑูุงูู ุตุญุจุช ฺฉูู. ูุง ุงูุฌุง ูุณุชู ุชุง ฺฉูฺฉ ฺฉููุ ูู ุจุญุซ ฺฉูู. ุงฺฏุฑ ูุดฺฉู ุฏุงุฑุฏุ ุจุง ุขุฑุงูุด ุจุงู ฺฉูุฏ ุชุง ุฑุงูโุญู ูพุฏุง ฺฉูู.",
                "ุฑูุชุงุฑ ูุญุชุฑูุงูู ุงููู ูุฏู ุจุฑุง ุญู ูุณุฆููโุณุช. ุงฺฏุฑ ูุงุฑุงุญุช ูุณุชุฏุ ุฏููุด ุฑู ุจฺฏุฏ ุชุง ุจุฑุทุฑูุด ฺฉูู."
            ],
            
            'fallback': [
                "ุณูุงู ุฎูุจ ูพุฑุณุฏุฏ! ูุนูุงู ุงุทูุงุนุงุช ุฏูู ุงุฒ ุงู ููุฑุฏ ูุฏุงุฑูุ ุงูุง ูโุชููู ุดูุง ุฑู ุจู ุจุฎุด ูุฑุจูุทู ูุตู ฺฉูู.",
                "ุงู ููุถูุน ฺฉู ุชุฎุตุตู. ูพุดููุงุฏ ูโฺฉูู ูุณุชูู ุจุง ูพุดุชุจุงู ุชูุงุณ ุจฺฏุฑุฏ ุชุง ุฏููโุชุฑ ุฑุงูููุงุชูู ฺฉููุฏ.",
                "ุจุฑุง ูพุงุณุฎ ุฏูู ุจู ุงู ุณูุงูุ ูุงุฒ ุฏุงุฑู ุจุง ููฺฉุงุฑุงูู ูุดูุฑุช ฺฉูู. ูุทูุงู ุตุจูุฑ ุจุงุดุฏ ุง ุจุง ูพุดุชุจุงู ุชูุงุณ ุจฺฏุฑุฏ."
            ]
        }
        
        # ฺฉููุงุช ฺฉูุฏ ุจุฑุง ุชุดุฎุต ููุถูุน
        self.keyword_groups = {
            'greeting': ['ุณูุงู', 'ุฏุฑูุฏ', 'ุฎุณุชู ูุจุงุดุฏ', 'ุนูฺฉ', 'ุงูุณูุงู'],
            'size': ['ุณุงุฒ', 'ุงูุฏุงุฒู', 'ุจุฒุฑฺฏ', 'ฺฉูฺฺฉ', 'ุฌ', 'ูุช', 'ฺฏุดุงุฏ', 'ุชูฺฏ', 'ูุฏ', 'ูุฒู'],
            'delivery': ['ุฒูุงู ุงุฑุณุงู', 'ุชุงุฎุฑ', 'ฺฉ ูุฑุณู', 'ฺูุฏ ุฑูุฒ', 'ุงุฑุณุงู', 'ุชุญูู', 'ุฏุฑ', 'ุนุฌูู'],
            'quality': ['ฺฉูุช', 'ุฌูุณ', 'ูพุงุฑฺู', 'ูุฎ', 'ฺุฑู', 'ุฏูุฎุช', 'ูุฑุบูุจ', 'ูุชุฑุงู'],
            'tracking': ['ูพฺฏุฑ', 'ูุถุนุช', 'ฺฉุฌุง', 'ุณูุงุฑุดู', 'ุชุญูู', 'ูููุนุช'],
            'return': ['ุจุงุฒฺฏุดุช', 'ูุฑุฌูุน', 'ุนูุฏุช', 'ูพูู', 'ุชุถูู', 'ฺฏุงุฑุงูุช', 'ุชุนูุถ'],
            'price': ['ููุช', 'ูุฒูู', 'ฺฏุฑูู', 'ุงุฑุฒุงู', 'ุชุฎูู', 'ุญุฑุงุฌ'],
            'human': ['ุงูุณุงู', 'ุงูพุฑุงุชูุฑ', 'ูุงูุน', 'ุฒูุฏู', 'ุตุญุจุช', 'ุชูุงุณ'],
            'insult': ['ุงุญูู', 'ูุงุฏุงู', 'ุจ ุดุนูุฑ', 'ฺฉุซุงูุช', 'ูุญุด', 'ุชููู', 'ุจ ุงุฏุจ'],
            'thanks': ['ููููู', 'ูุฑุณ', 'ุชุดฺฉุฑ', 'ุฏุณุช ูุฑุฒุงุฏ', 'ุฎู ููููู']
        }
        
        print("๐ค ุฑุจุงุช ููุดููุฏ APM Show ุฑุงูโุงูุฏุงุฒ ุดุฏ")
    
    def load_faq(self, faq_data: List[Dict]):
        """ุจุงุฑฺฏุฐุงุฑ FAQ"""
        self.faq_data = faq_data
        print(f"โ {len(faq_data)} ุณูุงู FAQ ุจุงุฑฺฏุฐุงุฑ ุดุฏ")
    
    def train_from_text(self, text: str):
        """ุขููุฒุด ุงุฒ ูุชู ุขููุฒุด"""
        print("๐ ุขููุฒุด ุฑุจุงุช ุงุฒ ูุชูโูุง ุขููุฒุด")
    
    def normalize_text(self, text: str) -> str:
        """ูุฑูุงูโุณุงุฒ ูุชู ูุงุฑุณ"""
        if not text:
            return ""
        
        # ุญุฐู ุนูุงุฆู ูฺฏุงุฑุด
        text = re.sub(r'[ุุ:.,!?;()\[\]{}]', ' ', text)
        
        # ุญุฐู ูุงุตููโูุง ุงุถุงู
        text = re.sub(r'\s+', ' ', text)
        
        # ุชุจุฏู ุจู ุญุฑูู ฺฉูฺฺฉ ูุงุฑุณ
        text = text.lower().strip()
        
        return text
    
    def find_faq_answer(self, question: str) -> Tuple[str, float]:
        """ุงูุชู ูพุงุณุฎ ุฏุฑ FAQ ุจุง ุดุจุงูุช ูุนูุง"""
        question_norm = self.normalize_text(question)
        
        best_match = None
        highest_similarity = 0.0
        
        for faq in self.faq_data:
            faq_question = self.normalize_text(faq.get('question', ''))
            
            # ูุญุงุณุจู ุดุจุงูุช ุณุงุฏู
            similarity = self.calculate_similarity(question_norm, faq_question)
            
            if similarity > highest_similarity:
                highest_similarity = similarity
                best_match = faq
        
        if best_match and highest_similarity >= 0.4:
            return best_match['answer'], highest_similarity
        
        return None, 0.0
    
    def calculate_similarity(self, text1: str, text2: str) -> float:
        """ูุญุงุณุจู ุดุจุงูุช ุจู ุฏู ูุชู"""
        if not text1 or not text2:
            return 0.0
        
        if text1 == text2:
            return 1.0
        
        # ุชูุณู ุจู ฺฉููุงุช
        words1 = set(text1.split())
        words2 = set(text2.split())
        
        if not words1 or not words2:
            return 0.0
        
        # ุงุดุชุฑุงฺฉ ู ุงุฌุชูุงุน
        intersection = words1.intersection(words2)
        union = words1.union(words2)
        
        if not union:
            return 0.0
        
        similarity = len(intersection) / len(union)
        
        # ุงูุฒุงุด ุงูุชุงุฒ ุจุฑุง ฺฉููุงุช ฺฉูุฏ ูุดุชุฑฺฉ
        keyword_score = 0
        for word in intersection:
            for category, keywords in self.keyword_groups.items():
                if word in keywords:
                    keyword_score += 0.2
        
        return min(1.0, similarity + keyword_score * 0.3)
    
    def detect_topic(self, text: str) -> str:
        """ุชุดุฎุต ููุถูุน ุณูุงู"""
        text_norm = self.normalize_text(text)
        words = text_norm.split()
        
        scores = {}
        
        for category, keywords in self.keyword_groups.items():
            score = 0
            for keyword in keywords:
                if keyword in text_norm:
                    score += 1
            
            if score > 0:
                scores[category] = score
        
        if scores:
            # ุจุฑฺฏุฑุฏุงูุฏู ููุถูุน ุจุง ุจุดุชุฑู ุงูุชุงุฒ
            return max(scores.items(), key=lambda x: x[1])[0]
        
        return 'unknown'
    
    def check_human_request(self, text: str) -> bool:
        """ุจุฑุฑุณ ุฏุฑุฎูุงุณุช ุงูพุฑุงุชูุฑ ุงูุณุงู"""
        text_lower = text.lower()
        human_keywords = ['ุงูุณุงู', 'ุงูพุฑุงุชูุฑ', 'ูุงูุน', 'ุฒูุฏู', 'ูพุดุชุจุงู ุงูุณุงู', 
                         'ูุดุงูุฑ ุงูุณุงู', 'ุตุญุจุช ุจุง ุงูุณุงู', 'ุขุฏู ูุงูุน', 'ุงูุณุงู']
        
        for keyword in human_keywords:
            if keyword in text_lower:
                return True
        
        return False
    
    def check_insult(self, text: str) -> bool:
        """ุจุฑุฑุณ ูุฌูุฏ ูุญุด ู ุชููู"""
        text_norm = self.normalize_text(text)
        
        for insult in self.keyword_groups['insult']:
            if insult in text_norm:
                return True
        
        return False
    
    def generate_smart_response(self, topic: str) -> str:
        """ุชููุฏ ูพุงุณุฎ ููุดููุฏ ุจุฑ ุงุณุงุณ ููุถูุน"""
        if topic in self.response_patterns:
            responses = self.response_patterns[topic]
            return random.choice(responses)
        
        return random.choice(self.response_patterns['fallback'])
    
    def process_message(self, message: str) -> Dict:
        """ูพุฑุฏุงุฒุด ูพุงู ฺฉุงุฑุจุฑ ู ุชููุฏ ูพุงุณุฎ"""
        message = message.strip()
        
        if not message:
            return {
                "reply": "ูุทูุงู ูพุงู ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ.",
                "confidence": 0,
                "source": "empty"
            }
        
        # ุจุฑุฑุณ ูุญุด
        if self.check_insult(message):
            return {
                "reply": random.choice(self.response_patterns['insult_response']),
                "confidence": 0.9,
                "source": "insult"
            }
        
        # ุจุฑุฑุณ ุณูุงู
        if self.detect_topic(message) == 'greeting':
            return {
                "reply": random.choice(self.response_patterns['greeting']),
                "confidence": 0.95,
                "source": "greeting"
            }
        
        # ุจุฑุฑุณ ุฏุฑุฎูุงุณุช ุงูพุฑุงุชูุฑ ุงูุณุงู
        if self.check_human_request(message):
            return {
                "reply": random.choice(self.response_patterns['human_request']),
                "confidence": 0.9,
                "source": "human_request"
            }
        
        # ุฌุณุชุฌู ุฏุฑ FAQ
        faq_answer, faq_confidence = self.find_faq_answer(message)
        
        if faq_answer and faq_confidence >= 0.4:
            return {
                "reply": faq_answer,
                "confidence": faq_confidence,
                "source": "faq"
            }
        
        # ุชุดุฎุต ููุถูุน
        topic = self.detect_topic(message)
        
        if topic != 'unknown':
            response = self.generate_smart_response(topic)
            
            # ุงฺฏุฑ ุณูุงู ุฏุฑุจุงุฑู ุณุงุฒ ุงุณุชุ ูพุงุณุฎ ฺฉุงููโุชุฑ ุจุฏู
            if topic == 'size':
                response += "\n\n๐ก ูฺฉุชู: ููุดู ูุจู ุงุฒ ุฎุฑุฏุ ูุธุฑุงุช ุฏฺฏุฑ ูุดุชุฑุงู ุฏุฑุจุงุฑู ุณุงุฒ ุฑู ูู ุจุฎููุฏ!"
            
            # ุงฺฏุฑ ุณูุงู ุฏุฑุจุงุฑู ุชุฃุฎุฑ ุงุณุช
            elif topic == 'delivery':
                response += "\n\n๐ ุขูุงุฑ: ุจุด ุงุฒ นธูช ุณูุงุฑุดุงุช ุฏุฑ ุฒูุงู ุงุนูุงู ุดุฏู ุชุญูู ุฏุงุฏู ุดุฏูโุงูุฏ!"
            
            return {
                "reply": response,
                "confidence": 0.85,
                "source": "smart_response"
            }
        
        # ูพุงุณุฎ ูพุดโูุฑุถ ููุดููุฏ
        fallback_responses = [
            "ุณูุงู ุฌุงูุจ ูพุฑุณุฏุฏ! ุจุฑุง ูพุงุณุฎ ุฏููโุชุฑุ ูุทูุงู ฺฉู ุจุดุชุฑ ุชูุถุญ ุจุฏุฏ.",
            "ูุชูุฌู ุณูุงู ุดูุง ุดุฏู. ุงฺฏุฑ ุฏุฑุจุงุฑู ุณุงุฒุ ุงุฑุณุงูุ ฺฉูุช ุง ููุช ุณูุงู ุฏุงุฑุฏุ ูโุชููู ฺฉูฺฉุชูู ฺฉูู.",
            "ุจุฑุง ูพุงุณุฎ ุจู ุงู ุณูุงูุ ูุงุฒ ุฏุงุฑู ุจุดุชุฑ ุจุฏููู ููุธูุฑุชูู ฺู. ูโุชููุฏ ุจู ุตูุฑุช ูุดุฎุตโุชุฑ ุจูพุฑุณุฏุ"
        ]
        
        return {
            "reply": random.choice(fallback_responses),
            "confidence": 0.6,
            "source": "fallback"
        }
